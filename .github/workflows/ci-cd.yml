name: CI/CD - AuraBeauty

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-1
  FRONTEND_DIR: app/frontend
  BACKEND_DIR: app/backend
  FRONTEND_REPO: aurabeauty-frontend
  BACKEND_REPO: aurabeauty-backend
  TAG: latest

jobs:
  build-scan-push-deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write     # required for OIDC
      contents: read

    steps:
    ###############################################
    # 1. CHECKOUT
    ###############################################
      - name: Checkout source code
        uses: actions/checkout@v4

    ###############################################
    # 2. CONFIGURE AWS (OIDC ONLY)
    ###############################################
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: aurabeauty-session
          aws-region: ${{ env.AWS_REGION }}

    ###############################################
    # 3. GET AWS ACCOUNT ID
    ###############################################
      - name: Get AWS Account ID
        id: aws
        run: echo "ACCOUNT=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

    ###############################################
    # 4. LOGIN TO ECR
    ###############################################
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin \
              ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com

    ###############################################
    # 5. BUILD BACKEND IMAGE
    ###############################################
      - name: Build Backend Docker image
        run: |
          docker build -t ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:$TAG \
          -f docker/backend.Dockerfile .


    ###############################################
    # 6. BUILD FRONTEND IMAGE
    ###############################################
      - name: Build Frontend Docker image
        run: |
          docker build -t ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:$TAG \
          -f docker/frontend.Dockerfile .


    ###############################################
    # 7. TRIVY SCAN (DOCKER VERSION) - BACKEND
    ###############################################
      - name: Trivy Scan Backend
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL,HIGH \
            ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:$TAG

    ###############################################
    # 8. TRIVY SCAN (DOCKER VERSION) - FRONTEND
    ###############################################
      - name: Trivy Scan Frontend
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL,HIGH \
            ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:$TAG

    ###############################################
    # 9. PUSH IMAGES TO ECR
    ###############################################
      - name: Push Images to ECR
        run: |
          docker push ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:$TAG
          docker push ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:$TAG

    ###############################################
    # 10. GET EC2 PUBLIC IP DYNAMICALLY
    ###############################################
      - name: Fetch EC2 Public IP
        id: ec2
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=aurabeauty-app" \
                     "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT

    ###############################################
    # 11. COPY DOCKER-COMPOSE FILE INTO EC2 (SCP)
    ###############################################
      - name: Copy docker-compose to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.ec2.outputs.EC2_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./docker-compose.yml"
          target: "/home/ubuntu/"

    ###############################################
    # 12. DEPLOY ON EC2 (SSH + DOCKER COMPOSE PULL/UP)
    ###############################################
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ steps.ec2.outputs.EC2_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu
            aws ecr get-login-password --region ap-south-1 \
              | docker login --username AWS --password-stdin \
                ${{ steps.aws.outputs.ACCOUNT }}.dkr.ecr.ap-south-1.amazonaws.com

            docker compose pull
            docker compose up -d
